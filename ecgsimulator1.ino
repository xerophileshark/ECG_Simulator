/*
 * File name: ecg.ino
 * Tested on Arduino Due on Monday, October 28, 2019, 13:22'
 * By: Ali Abedi, aliabediemail@yahoo.com
 * Notes:
 *  1. First and last element of the dara array should be zero(0).
 *  2. Maximum HR that can be produced by this samples is 80 BPM. (751 point = 0.75 sec in 1000 Hz sampling rate)
 *  3. The sampling frequency is set to 1000 Hz using TC1 interrupt.
 *  
*/

#include <math.h>

#define SAMPLE_FREQ 1000 //Hz

double HRdata[751] = {0.0002,
                      0.0009,
                      0.0016,
                      0.0022,
                      0.0029,
                      0.0036,
                      0.0045,
                      0.0054,
                      0.0063,
                      0.0071,
                      0.0080,
                      0.0091,
                      0.0102,
                      0.0113,
                      0.0124,
                      0.0135,
                      0.0158,
                      0.0182,
                      0.0206,
                      0.0230,
                      0.0253,
                      0.0290,
                      0.0327,
                      0.0365,
                      0.0402,
                      0.0439,
                      0.0481,
                      0.0524,
                      0.0567,
                      0.0609,
                      0.0652,
                      0.0701,
                      0.0749,
                      0.0798,
                      0.0847,
                      0.0896,
                      0.0953,
                      0.1011,
                      0.1069,
                      0.1126,
                      0.1184,
                      0.1239,
                      0.1294,
                      0.1349,
                      0.1404,
                      0.1460,
                      0.1506,
                      0.1552,
                      0.1598,
                      0.1644,
                      0.1691,
                      0.1730,
                      0.1770,
                      0.1809,
                      0.1849,
                      0.1888,
                      0.1914,
                      0.1939,
                      0.1965,
                      0.1991,
                      0.2016,
                      0.2024,
                      0.2031,
                      0.2039,
                      0.2046,
                      0.2054,
                      0.2049,
                      0.2045,
                      0.2040,
                      0.2036,
                      0.2031,
                      0.2018,
                      0.2005,
                      0.1992,
                      0.1978,
                      0.1965,
                      0.1940,
                      0.1915,
                      0.1890,
                      0.1866,
                      0.1841,
                      0.1808,
                      0.1774,
                      0.1741,
                      0.1708,
                      0.1675,
                      0.1640,
                      0.1605,
                      0.1570,
                      0.1535,
                      0.1500,
                      0.1462,
                      0.1424,
                      0.1386,
                      0.1349,
                      0.1311,
                      0.1271,
                      0.1231,
                      0.1192,
                      0.1152,
                      0.1112,
                      0.1070,
                      0.1029,
                      0.0987,
                      0.0945,
                      0.0903,
                      0.0855,
                      0.0807,
                      0.0759,
                      0.0711,
                      0.0663,
                      0.0610,
                      0.0558,
                      0.0506,
                      0.0454,
                      0.0402,
                      0.0355,
                      0.0309,
                      0.0263,
                      0.0217,
                      0.0170,
                      0.0131,
                      0.0092,
                      0.0053,
                      0.0014,
                      -0.0026,
                      -0.0062,
                      -0.0099,
                      -0.0136,
                      -0.0173,
                      -0.0209,
                      -0.0235,
                      -0.0260,
                      -0.0285,
                      -0.0310,
                      -0.0336,
                      -0.0343,
                      -0.0351,
                      -0.0359,
                      -0.0367,
                      -0.0375,
                      -0.0375,
                      -0.0376,
                      -0.0376,
                      -0.0377,
                      -0.0377,
                      -0.0377,
                      -0.0377,
                      -0.0377,
                      -0.0377,
                      -0.0376,
                      -0.0381,
                      -0.0386,
                      -0.0391,
                      -0.0395,
                      -0.0400,
                      -0.0434,
                      -0.0468,
                      -0.0502,
                      -0.0536,
                      -0.0570,
                      -0.0636,
                      -0.0702,
                      -0.0768,
                      -0.0834,
                      -0.0900,
                      -0.0737,
                      -0.0574,
                      -0.0411,
                      -0.0248,
                      -0.0085,
                      0.0065,
                      0.0215,
                      0.0365,
                      0.0515,
                      0.0664,
                      0.0972,
                      0.1280,
                      0.1588,
                      0.1896,
                      0.2204,
                      0.2700,
                      0.3197,
                      0.3694,
                      0.4190,
                      0.4687,
                      0.5336,
                      0.5985,
                      0.6635,
                      0.7284,
                      0.7934,
                      0.8629,
                      0.9325,
                      1.0021,
                      1.0716,
                      1.1412,
                      1.2030,
                      1.2649,
                      1.3268,
                      1.3886,
                      1.4505,
                      1.4911,
                      1.5317,
                      1.5723,
                      1.6129,
                      1.6535,
                      1.6661,
                      1.6787,
                      1.6834,
                      1.6803,
                      1.6771,
                      1.6409,
                      1.6047,
                      1.5685,
                      1.5323,
                      1.4961,
                      1.4269,
                      1.3578,
                      1.2886,
                      1.2195,
                      1.1503,
                      1.0638,
                      0.9772,
                      0.8906,
                      0.8041,
                      0.7175,
                      0.6292,
                      0.5409,
                      0.4526,
                      0.3642,
                      0.2759,
                      0.2002,
                      0.1245,
                      0.0488,
                      -0.0269,
                      -0.1026,
                      -0.1537,
                      -0.2048,
                      -0.2558,
                      -0.3069,
                      -0.3579,
                      -0.3817,
                      -0.4055,
                      -0.4293,
                      -0.4531,
                      -0.4768,
                      -0.4830,
                      -0.4892,
                      -0.4900,
                      -0.4853,
                      -0.4806,
                      -0.4655,
                      -0.4504,
                      -0.4353,
                      -0.4202,
                      -0.4051,
                      -0.3825,
                      -0.3599,
                      -0.3372,
                      -0.3146,
                      -0.2920,
                      -0.2681,
                      -0.2441,
                      -0.2202,
                      -0.1962,
                      -0.1723,
                      -0.1510,
                      -0.1298,
                      -0.1085,
                      -0.0872,
                      -0.0659,
                      -0.0489,
                      -0.0319,
                      -0.0148,
                      0.0022,
                      0.0193,
                      0.0317,
                      0.0442,
                      0.0566,
                      0.0690,
                      0.0815,
                      0.0899,
                      0.0984,
                      0.1068,
                      0.1152,
                      0.1236,
                      0.1294,
                      0.1351,
                      0.1408,
                      0.1465,
                      0.1522,
                      0.1555,
                      0.1589,
                      0.1622,
                      0.1655,
                      0.1688,
                      0.1709,
                      0.1730,
                      0.1750,
                      0.1771,
                      0.1791,
                      0.1811,
                      0.1831,
                      0.1850,
                      0.1870,
                      0.1890,
                      0.1904,
                      0.1918,
                      0.1933,
                      0.1947,
                      0.1961,
                      0.1969,
                      0.1978,
                      0.1986,
                      0.1994,
                      0.2002,
                      0.2011,
                      0.2020,
                      0.2029,
                      0.2038,
                      0.2047,
                      0.2056,
                      0.2066,
                      0.2075,
                      0.2085,
                      0.2094,
                      0.2098,
                      0.2102,
                      0.2106,
                      0.2110,
                      0.2113,
                      0.2116,
                      0.2119,
                      0.2122,
                      0.2125,
                      0.2129,
                      0.2140,
                      0.2152,
                      0.2163,
                      0.2175,
                      0.2186,
                      0.2202,
                      0.2218,
                      0.2235,
                      0.2251,
                      0.2267,
                      0.2286,
                      0.2305,
                      0.2324,
                      0.2343,
                      0.2362,
                      0.2390,
                      0.2419,
                      0.2447,
                      0.2476,
                      0.2504,
                      0.2540,
                      0.2576,
                      0.2613,
                      0.2649,
                      0.2685,
                      0.2727,
                      0.2768,
                      0.2810,
                      0.2851,
                      0.2892,
                      0.2943,
                      0.2993,
                      0.3043,
                      0.3094,
                      0.3144,
                      0.3204,
                      0.3264,
                      0.3324,
                      0.3384,
                      0.3444,
                      0.3513,
                      0.3582,
                      0.3651,
                      0.3720,
                      0.3789,
                      0.3871,
                      0.3953,
                      0.4034,
                      0.4116,
                      0.4198,
                      0.4293,
                      0.4389,
                      0.4485,
                      0.4580,
                      0.4676,
                      0.4781,
                      0.4886,
                      0.4990,
                      0.5095,
                      0.5200,
                      0.5312,
                      0.5425,
                      0.5537,
                      0.5650,
                      0.5762,
                      0.5881,
                      0.5999,
                      0.6118,
                      0.6237,
                      0.6355,
                      0.6470,
                      0.6585,
                      0.6700,
                      0.6815,
                      0.6930,
                      0.7033,
                      0.7137,
                      0.7241,
                      0.7345,
                      0.7449,
                      0.7544,
                      0.7639,
                      0.7734,
                      0.7829,
                      0.7924,
                      0.8003,
                      0.8082,
                      0.8162,
                      0.8241,
                      0.8320,
                      0.8373,
                      0.8427,
                      0.8480,
                      0.8533,
                      0.8586,
                      0.8619,
                      0.8651,
                      0.8684,
                      0.8716,
                      0.8748,
                      0.8762,
                      0.8775,
                      0.8788,
                      0.8801,
                      0.8815,
                      0.8801,
                      0.8787,
                      0.8773,
                      0.8759,
                      0.8745,
                      0.8704,
                      0.8663,
                      0.8622,
                      0.8580,
                      0.8539,
                      0.8476,
                      0.8412,
                      0.8348,
                      0.8285,
                      0.8221,
                      0.8135,
                      0.8048,
                      0.7962,
                      0.7876,
                      0.7790,
                      0.7680,
                      0.7569,
                      0.7459,
                      0.7349,
                      0.7239,
                      0.7112,
                      0.6986,
                      0.6860,
                      0.6734,
                      0.6608,
                      0.6473,
                      0.6338,
                      0.6204,
                      0.6069,
                      0.5934,
                      0.5793,
                      0.5652,
                      0.5511,
                      0.5370,
                      0.5229,
                      0.5091,
                      0.4953,
                      0.4815,
                      0.4677,
                      0.4539,
                      0.4411,
                      0.4283,
                      0.4154,
                      0.4026,
                      0.3898,
                      0.3777,
                      0.3656,
                      0.3536,
                      0.3415,
                      0.3294,
                      0.3187,
                      0.3080,
                      0.2973,
                      0.2866,
                      0.2759,
                      0.2670,
                      0.2580,
                      0.2491,
                      0.2402,
                      0.2313,
                      0.2235,
                      0.2157,
                      0.2079,
                      0.2001,
                      0.1923,
                      0.1857,
                      0.1791,
                      0.1725,
                      0.1659,
                      0.1593,
                      0.1543,
                      0.1493,
                      0.1444,
                      0.1394,
                      0.1344,
                      0.1307,
                      0.1269,
                      0.1232,
                      0.1195,
                      0.1157,
                      0.1126,
                      0.1094,
                      0.1063,
                      0.1031,
                      0.0999,
                      0.0979,
                      0.0958,
                      0.0938,
                      0.0917,
                      0.0896,
                      0.0890,
                      0.0884,
                      0.0878,
                      0.0872,
                      0.0866,
                      0.0865,
                      0.0864,
                      0.0863,
                      0.0862,
                      0.0861,
                      0.0867,
                      0.0872,
                      0.0878,
                      0.0883,
                      0.0889,
                      0.0908,
                      0.0927,
                      0.0945,
                      0.0964,
                      0.0983,
                      0.1008,
                      0.1033,
                      0.1058,
                      0.1083,
                      0.1108,
                      0.1126,
                      0.1145,
                      0.1163,
                      0.1182,
                      0.1200,
                      0.1229,
                      0.1258,
                      0.1286,
                      0.1315,
                      0.1344,
                      0.1367,
                      0.1390,
                      0.1413,
                      0.1435,
                      0.1458,
                      0.1474,
                      0.1489,
                      0.1505,
                      0.1520,
                      0.1536,
                      0.1548,
                      0.1560,
                      0.1572,
                      0.1584,
                      0.1596,
                      0.1608,
                      0.1620,
                      0.1632,
                      0.1644,
                      0.1656,
                      0.1664,
                      0.1672,
                      0.1680,
                      0.1688,
                      0.1697,
                      0.1705,
                      0.1713,
                      0.1722,
                      0.1730,
                      0.1738,
                      0.1751,
                      0.1764,
                      0.1777,
                      0.1790,
                      0.1803,
                      0.1816,
                      0.1829,
                      0.1842,
                      0.1855,
                      0.1868,
                      0.1877,
                      0.1887,
                      0.1897,
                      0.1906,
                      0.1916,
                      0.1926,
                      0.1936,
                      0.1946,
                      0.1956,
                      0.1965,
                      0.1974,
                      0.1982,
                      0.1991,
                      0.1999,
                      0.2007,
                      0.2010,
                      0.2013,
                      0.2016,
                      0.2019,
                      0.2022,
                      0.2025,
                      0.2027,
                      0.2029,
                      0.2031,
                      0.2034,
                      0.2034,
                      0.2034,
                      0.2034,
                      0.2035,
                      0.2035,
                      0.2026,
                      0.2017,
                      0.2008,
                      0.1999,
                      0.1990,
                      0.1978,
                      0.1965,
                      0.1952,
                      0.1940,
                      0.1927,
                      0.1916,
                      0.1905,
                      0.1893,
                      0.1882,
                      0.1871,
                      0.1853,
                      0.1835,
                      0.1817,
                      0.1799,
                      0.1781,
                      0.1754,
                      0.1726,
                      0.1698,
                      0.1670,
                      0.1643,
                      0.1616,
                      0.1590,
                      0.1564,
                      0.1538,
                      0.1512,
                      0.1488,
                      0.1464,
                      0.1440,
                      0.1416,
                      0.1392,
                      0.1362,
                      0.1332,
                      0.1302,
                      0.1272,
                      0.1242,
                      0.1211,
                      0.1180,
                      0.1149,
                      0.1119,
                      0.1088,
                      0.1062,
                      0.1036,
                      0.1010,
                      0.0985,
                      0.0959,
                      0.0933,
                      0.0908,
                      0.0883,
                      0.0858,
                      0.0832,
                      0.0809,
                      0.0786,
                      0.0762,
                      0.0739,
                      0.0715,
                      0.0700,
                      0.0684,
                      0.0669,
                      0.0653,
                      0.0637,
                      0.0626,
                      0.0615,
                      0.0604,
                      0.0592,
                      0.0581,
                      0.0566,
                      0.0551,
                      0.0535,
                      0.0520,
                      0.0505,
                      0.0484,
                      0.0463,
                      0.0442,
                      0.0421,
                      0.0400,
                      0.0380,
                      0.0360,
                      0.0340,
                      0.0320,
                      0.0300,
                      0.0282,
                      0.0264,
                      0.0246,
                      0.0228,
                      0.0210,
                      0.0192,
                      0.0174,
                      0.0156,
                      0.0138,
                      0.0120,
                      0.0112,
                      0.0104,
                      0.0096,
                      0.0088,
                      0.0080,
                      0.0068,
                      0.0056,
                      0.0044,
                      0.0032,
                      0.0020,
                      0.0016,
                      0.0012,
                      0.0008,
                      0.0004,
                      0
                     };

volatile int i;
volatile double delta_t;
volatile int HR; // HeartRate (BPM)
volatile bool outputflag;
volatile bool noiseflag;
volatile int state;
volatile int Delay;

//Timer Interrupt Service: TC1 ch 0:
void TC3_Handler()
{
  TC_GetStatus(TC1, 0); // ???
  if (outputflag) {
    if (state == 1) {
      double output = HRdata[i] + 0.4900; //min(HRdata = -0.4900)
      i++;
      if (i == 751) {
        i = 0;
        state++;
      }
      long randNumber = random(500); // About 0.2655 volts
      analogWrite(DAC0, (int)(((noiseflag == true) ? randNumber : 0.0) + output * 1884.1447));
    } else if (state == 2) {
      double delta_t = 60.00 / (double)HR;
      Delay = (int)(1000 * (delta_t - 0.750)); //750 is minimum Delay available for this set of data "HRdata".
      if (Delay < 0) {
        Delay = 0;
      }
      Serial.println(Delay);
      i++;
      if (i >= Delay) {
        i = 0;
        state--;
      }
    } else {
      state = 1;
    }
  }
}

void startTimer(Tc *tc, uint32_t channel, IRQn_Type irq, uint32_t frequency) {
  pmc_set_writeprotect(false);
  pmc_enable_periph_clk((uint32_t)irq);
  TC_Configure(tc, channel, TC_CMR_WAVE | TC_CMR_WAVSEL_UP_RC | TC_CMR_TCCLKS_TIMER_CLOCK4);
  uint32_t rc = VARIANT_MCK / 128 / frequency; //128 because we selected TIMER_CLOCK4 above
  TC_SetRA(tc, channel, rc / 2); //50% high, 50% low
  TC_SetRC(tc, channel, rc);
  TC_Start(tc, channel);
  tc->TC_CHANNEL[channel].TC_IER = TC_IER_CPCS;
  tc->TC_CHANNEL[channel].TC_IDR = ~TC_IER_CPCS;
  NVIC_EnableIRQ(irq);
}

void setup() {
  analogWriteResolution(12); // The default resolution is 8 bit.

  // Initialize variables:
  delta_t = 1.0 / SAMPLE_FREQ;
  HR = 0;
  outputflag = false;
  Delay = 0;
  state = 1;

  // Start timer interrupt service:
  startTimer(TC1, 0, TC3_IRQn, SAMPLE_FREQ); //TC1 channel 0, the IRQ for that channel and the desired frequency (=1000HZ)

  //Random seed
  randomSeed(analogRead(A0));

  // Initialize Serial Interface:
  Serial.begin(115200);
}//end setup

void loop() {
  if (outputflag == false) {
    while (true) {
      if (Serial.available()) {
        HR = Serial.readString().toInt();
        Serial.println(""); Serial.print("[OK] "); Serial.print(HR); Serial.println(" is selected as HR.");
        Serial.println("Do you want noise?");
        while (!Serial.available()) {}
        String d = Serial.readString();
        if (d.indexOf("y") >= 0) {
          noiseflag = true;
          Serial.println("[OK] Noise generation: True!");
        } else {
          noiseflag = false;
          Serial.println("[OK] Noise generation: False!");
        }
        outputflag = true;
        Serial.println("[OK] Signal generation started!");
        break;
      } else {
        Serial.println(".");
        delay(100);
      }
    }
  }
}
